<div class="card-header">
    <h5>Vergleichsliste</h5>
</div>
<div class="card-body">
    <div class="table-responsive">
        <table id="compare_data_table" class="table table-hover table-bordered">
        <thead>
            <tr>
                <th scope="col">TF</th>
                <th scope="col">GF</th>
                <th scope="col">AF</th>
                {# <th scope="col">Rolle</th> #}
            </tr>
        </thead>
        <tbody>
            {% for row in compareUser_table_data %}
                <tr>
                    <td>{{ row.0 }}</td>
                    <td>{{ row.1 }}</td>
                    <td>{{ row.2 }}</td>
                </tr>
            {% endfor %}
        </tbody>
        </table>
        <script type="text/javascript">
            var user_pk = {{ user.pk }};
            var CSRF_TOKEN = "{{ csrf_token }}";
            var compare_data_table;
            $(document).ready(function() {

                compare_data_table = $('#compare_data_table').DataTable({
                    "pageLength":10,
                    "aLengthMenu":[[10,25,50,100,-1],[10,25,50,100,"All"]],
                });

                $('#compare_data_table tbody').on('contextmenu', 'td', function (e) {
                    e.preventDefault();

                    var cell_data = window.compare_data_table.cell( this ).data();
                    var colIndex = window.compare_data_table.cell(this).index().column;
                    var rowIndex = window.compare_data_table.cell( this ).index().row;
                    var row_data=window.compare_data_table.row(rowIndex).data();
                    var right_type="",right_parent = "",right_grandparent = "";
                    if(colIndex===0){
                        right_type="tf";
                        right_grandparent = row_data[2];
                        right_parent = row_data[1];
                    }else if (colIndex===1){
                        right_type="gf";
                        right_parent = row_data[2];
                    }else if (colIndex===2){
                        right_type="af";
                    }

                    var r = confirm("Berechtigung:\n\n"+cell_data+"\n\nwirklich zu Löschliste hinzufügen?\n\n");
                    if (r === true){
                        function getCookie(name) {
                            var cookieValue = null;
                            if (document.cookie && document.cookie !== '') {
                                var cookies = document.cookie.split(';');
                                for (var i = 0; i < cookies.length; i++) {
                                    var cookie = jQuery.trim(cookies[i]);
                                    // Does this cookie string begin with the name we want?
                                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                            return cookieValue;
                        }
                        function csrfSafeMethod(method) {
                            // these HTTP methods do not require CSRF protection
                            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                        }
                        $.ajaxSetup({
                            beforeSend: function(xhr, settings) {
                                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                                    xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                                }
                            }
                        });
                        var data = {"X-CSRFToken":getCookie("csrftoken"),"X_METHODOVERRIDE":'PATCH',"user_pk":window.user_pk,"action_type":"trash","right_type":right_type,"right_name":cell_data,"parent":right_parent,"grandparent":right_grandparent};
                        var successful=false;
                        $.ajax({type:'POST',
                                data:data,
                                url:'http://127.0.0.1:8000/users/'+window.user_pk+'/',
                                async:false,
                                success: function(res){console.log(res);
                                    alert("Berechtigung zur\n\nLöschliste hinzugefügt\n");
                                    successful=true},
                                error: function(res){console.log(res);}
                                });
                        if(successful===true){
                            console.log("success!");
                            update_table_data(cell_data,right_type,row_data);
                        }
                    }
                } ).on('mouseenter', 'td', function (e) {
                    e.preventDefault();
                    var colIndex = window.compare_data_table.cell(this).index().column;
                    $(window.compare_data_table.cells().nodes()).removeClass('highlight');
                    $(window.compare_data_table.column(colIndex).nodes()).addClass('highlight');
                });
                function update_table_data(cell_data,right_type,row_data) {
                    var rows_to_delete = [];
                    if (right_type==="af"){
                        var old_gfs=[];
                        window.compare_data_table.rows().every(function(rowIdx,tableLoop,rowLoop){
                           var data = this.data();
                           if(data[2]===cell_data){
                               rows_to_delete.push(this.node());
                               window.trash_table.row.add(data).draw();
                               window.trash_table_count+=1;
                               document.getElementById('trash_badge').innerHTML = window.trash_table_count;
                           }
                        });
                        rows_to_delete.forEach(function(node){
                           window.compare_data_table.row(node).remove().draw();
                        });
                        window.compare_data_table.draw()
                    }
                    if (right_type==="gf"){
                        window.compare_data_table.rows().every(function(rowIdx,tableLoop,rowLoop){
                           var data = this.data();
                           if(data[1]===cell_data&&data[2]===row_data[2]){
                               rows_to_delete.push(this.node());
                               window.trash_table.row.add(data).draw();
                               window.trash_table_count+=1;
                               document.getElementById('trash_badge').innerHTML = window.trash_table_count;
                           }
                        });

                        rows_to_delete.forEach(function(node){
                           window.compare_data_table.row(node).remove().draw();
                        });
                        window.compare_data_table.draw()
                    }
                    //TODO: noch so ändern, dass row nicht ers gesucht werden muss sondern direkt gelöscht wird!
                    if (right_type==="tf"){
                        window.compare_data_table.rows().every(function(rowIdx,tableLoop,rowLoop){
                           var data = this.data();
                           if(data[0]===cell_data&&data[1]===row_data[1]&&data[2]===row_data[2]){
                               rows_to_delete.push(this.node());
                               window.trash_table.row.add(data).draw();
                               window.trash_table_count+=1;
                               document.getElementById('trash_badge').innerHTML = window.trash_table_count;
                           }
                        });
                        rows_to_delete.forEach(function(node){
                           window.compare_data_table.row(node).remove().draw();
                        });
                        window.compare_data_table.draw()
                    }
                }
            } );
        </script>
    </div>
</div>
<div class="card-footer">
</div>


<!--
{% if is_paginated %}
<ul class="pagination">
    {% if compareUser_table_data.has_previous %}
    <li>
        <a href="?userSearch={{ compareUser.identity }}&page={{ page_obj.number }}&compare_page={{ compareUser_table_data.previous_page_number }}&view_mode=Tabellarische Ansicht">&laquo;</a>
    </li>
    {% else %}
    <li class="disabled"><span>&laquo;</span></li>
    {% endif %}
    {% for i in compareUser_table_data.paginator.page_range %}
    {% if compareUser_table_data.number == i %}
    <li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
    {% else %}
    <li><a href="?userSearch={{ compareUser.identity }}&page={{ page_obj.number }}&compare_page={{ i }}&view_mode=Tabellarische Ansicht">{{ i }}</a>
    </li>
    {% endif %}
    {% endfor %}
    {% if compareUser_table_data.has_next %}
    <li>
        <a href="?userSearch={{ compareUser.identity }}&page={{ page_obj.number }}&compare_page={{ compareUser_table_data.next_page_number }}&view_mode=Tabellarische Ansicht">&raquo;</a>
    </li>
    {% else %}
    <li class="disabled"><span>&raquo;</span></li>
    {% endif %}
</ul>
{% endif %}
-->