{% load static %}
<div class="card">
    <div class="card-header">
        <h5>Transferliste <span id="transfer_badge" class="badge badge-success">{{ transfer_list_count }}</span></h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="transfer_table" class="table table-hover table-bordered">
                <thead>
                    <tr>
                        <th scope="col">TF</th>
                        <th scope="col">GF</th>
                        <th scope="col">AF</th>
                        {# <th scope="col">Rolle</th> #}
                    </tr>
                </thead>
                <tbody>
                    {% for row in transfer_list_table_data %}
                    <tr>
                        <td>{{ row.0 }}</td>
                        <td>{{ row.1 }}</td>
                        <td>{{ row.2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        <script type="text/javascript">
            var user_pk = {{ user.pk }};
            var CSRF_TOKEN = "{{ csrf_token }}";
            var transfer_table;

            $(document).ready(function() {
                transfer_table = $('#transfer_table').DataTable({
                    "pageLength":3,
                    "aLengthMenu":[[3,10,25,50,100,-1],[3,10,25,50,100,"All"]],
                });

                $('#transfer_table tbody').on('contextmenu', 'td', function (e) {
                    e.preventDefault();
                    var cell_data = window.transfer_table.cell( this ).data();
                    var colIndex = window.transfer_table.cell(this).index().column;
                    var rowIndex = window.transfer_table.cell( this ).index().row;
                    var row_data=window.transfer_table.row(rowIndex).data();
                    var right_type="",right_parent = "",right_grandparent = "";

                    var parentAndGrandparentExists = false;
                    var parentExists = false;
                    window.data_table.rows().every(function(rowIdx,tableLoop,rowLoop){
                       var data = this.data();
                       if(data[1]===row_data[1]&&data[2]===row_data[2]){
                           parentAndGrandparentExists = true;
                       }
                       else if(data[2]===row_data[2]){
                           parentExists = true;
                       }
                    });
                    alert("parentexists: "+parentExists+"\ngrandparent&gparentexists: "+parentAndGrandparentExists);

                    if(colIndex===0&&parentAndGrandparentExists){
                        right_type="tf";
                        right_grandparent = row_data[2];
                        right_parent = row_data[1];
                    }else if (colIndex===1&&parentExists){
                        right_type="gf";
                        right_parent = row_data[2];
                    }else if (colIndex===2){
                        right_type="af";
                    }else{
                        alert("Berechtigung:\n\n"+cell_data+"\n\nkann nicht wiederhergestellt werden!\n\nBerechtigungsbündel können nur\nkomplett wiederhergestellt werden!");
                        return;
                    }
                    var r = confirm("Berechtigung:\n\n"+cell_data+"\n\nwirklich von Transferliste entfernen\nund wiederherstellen?\n\n");
                    if (r === true){
                        function getCookie(name) {
                            var cookieValue = null;
                            if (document.cookie && document.cookie !== '') {
                                var cookies = document.cookie.split(';');
                                for (var i = 0; i < cookies.length; i++) {
                                    var cookie = jQuery.trim(cookies[i]);
                                    // Does this cookie string begin with the name we want?
                                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                            return cookieValue;
                        }
                        function csrfSafeMethod(method) {
                            // these HTTP methods do not require CSRF protection
                            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                        }
                        $.ajaxSetup({
                            beforeSend: function(xhr, settings) {
                                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                                    xhr.setRequestHeader("X-CSRFToken", getCookie("csrftoken"));
                                }
                            }
                        });
                        var data = {"X-CSRFToken":getCookie("csrftoken"),"X_METHODOVERRIDE":'PATCH',"user_pk":window.user_pk,"action_type":"restore","right_type":right_type,"right_name":cell_data,"parent":right_parent,"grandparent":right_grandparent};
                        var successful=false;
                        $.ajax({type:'POST',
                                data:data,
                                url:'http://127.0.0.1:8000/users/'+window.user_pk+'/',
                                async:false,
                                success: function(res){console.log("Success!: "+res);
                                    update_table_data(cell_data,right_type,row_data);
                                    alert("Berechtigung von\n\nTransferliste entfernt\nund wieder hergestellt!\n");
                                    },
                                error: function(res){console.log(res);}
                                });
                    }
                } ).on('mouseenter', 'td', function (e) {
                    e.preventDefault();
                    var colIndex = window.transfer_table.cell(this).index().column;
                    $(window.transfer_table.cells().nodes()).removeClass('highlight');
                    $(window.transfer_table.column(colIndex).nodes()).addClass('highlight');
                });
                function update_table_data(cell_data,right_type,row_data) {
                    var rows_to_restore = [];
                    var old_gfs=[],old_afs =[], found_gfs = [],found_afs=[];
                    if (right_type==="af"){
                        window.transfer_table.rows().every(function(rowIdx,tableLoop,rowLoop){
                           var data = this.data();
                           if(data[2]===cell_data){
                               rows_to_restore.push(this.node());
                               window.data_table.row.add(data).draw();
                               window.transfer_table_count-=1;
                               document.getElementById('transfer_badge').innerHTML = window.transfer_table_count;
                           }
                        });
                        rows_to_restore.forEach(function(node){
                           window.transfer_table.row(node).remove().draw();
                        });
                        window.transfer_table.draw()
                    }
                    if (right_type==="gf"){
                        window.transfer_table.rows().every(function(rowIdx,tableLoop,rowLoop){
                           var data = this.data();
                           if(data[1]===cell_data&&data[2]===row_data[2]){
                               rows_to_restore.push(this.node());
                               window.data_table.row.add(data).draw();
                               window.transfer_table_count-=1;
                               document.getElementById('transfer_badge').innerHTML = window.transfer_table_count;
                           }
                        });

                        rows_to_restore.forEach(function(node){
                           window.transfer_table.row(node).remove().draw();
                        });
                        window.transfer_table.draw()
                    }
                    //TODO: noch so ändern, dass row nicht ers gesucht werden muss sondern direkt geTransfert wird!
                    if (right_type==="tf"){
                        window.transfer_table.rows().every(function(rowIdx,tableLoop,rowLoop){
                           var data = this.data();
                           if(data[0]===cell_data&&data[1]===row_data[1]&&data[2]===row_data[2]){
                               rows_to_restore.push(this.node());
                               window.data_table.row.add(data).draw();
                               window.transfer_table_count-=1;
                               document.getElementById('transfer_badge').innerHTML = window.transfer_table_count;
                           }
                        });
                        rows_to_restore.forEach(function(node){
                           window.transfer_table.row(node).remove().draw();
                        });
                        window.transfer_table.draw()
                    }
                }
            } );
        </script>
        </div>
    </div>
    <div class="card-footer">
        <p class="card-text"> Übertragene Rechte werden hier angezeigt</p>
    </div>
    <!--
        {% if is_paginated %}
        <ul class="pagination">
            {% if delete_list_table_data.has_previous %}
                {% if identity_param %}
                    <li>
                        <a href="?identity={{ identity_param }}&page={{ page_obj.number }}&delete_list_page={{ delete_list_table_data.previous_page_number }}&view_mode=Tabellarische Ansicht">&laquo;</a>
                    </li>
                {% else %}
                    <li>
                        <a href="?page={{ page_obj.number }}&delete_list_page={{ delete_list_table_data.previous_page_number }}&view_mode=Tabellarische Ansicht">&laquo;</a>
                    </li>
                {% endif %}
            {% else %}
            <li class="disabled"><span>&laquo;</span></li>
            {% endif %}
            {% for i in delete_list_table_data.paginator.page_range %}
                {% if identity_param %}
                    {% if delete_list_table_data.number == i %}
                        <li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
                    {% else %}
                        <li><a href="?identity={{ identity_param }}&page={{ page_obj.number }}&delete_list_page={{ i }}&view_mode=Tabellarische Ansicht">{{ i }}</a>
                        </li>
                    {% endif %}
                {% else %}
                    {% if delete_list_table_data.number == i %}
                        <li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
                    {% else %}
                        <li><a href="?page={{ page_obj.number }}&delete_list_page={{ i }}&view_mode=Tabellarische Ansicht">{{ i }}</a>
                        </li>
                    {% endif %}
                {% endif %}
            {% endfor %}
            {% if identity_param %}
                {% if delete_list_table_data.has_next %}
                    <li><a href="?identity={{ identity_param }}&page={{ page_obj.number }}&delete_list_page={{ delete_list_table_data.next_page_number }}&view_mode=Tabellarische Ansicht">&raquo;</a></li>
                {% else %}
                    <li class="disabled"><span>&raquo;</span></li>
                {% endif %}
            {% else %}
                {% if delete_list_table_data.has_next %}
                    <li><a href="?page={{ page_obj.number }}&delete_list_page={{ delete_list_table_data.next_page_number }}&view_mode=Tabellarische Ansicht">&raquo;</a></li>
                {% else %}
                    <li class="disabled"><span>&raquo;</span></li>
                {% endif %}
            {% endif %}
            </ul>
        {% endif %}
        -->


</div>